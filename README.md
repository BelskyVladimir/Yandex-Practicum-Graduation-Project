# Прогнозирование оттока клиентов

Оператор связи хочет научиться прогнозировать отток клиентов. Если выяснится, что пользователь планирует уйти, ему будут предложены промокоды и специальные условия. Команда оператора собрала персональные данные о некоторых клиентах, информацию об их тарифах и договорах.

<b>Цель:</b> Построение модели машинного обучения, позволяющей на основании предоставленной заказчиком информации о персональных данных, договорах и тарифах прогнозировать отток клиентов с наилучшей точностью. Значение метрики AUC-ROC должно быть не менее 0.85.

<b>Этапы исследования:</b> 
1. Чтение и подготовка данных.
2. Исследовательский анализ данных.
3. Подготовка данных к машинному обучению.
4. Построение различных моделей и их оценка с помощью крос-валидации на тренировочной выборке.
5. Выбор лучшей модели и проверка ее на тестовой выборке.
6. Выводы.

## Выводы
Исходные данные, содержащиеся в 4 файлах, были загружены и объединены в один датафрейм по общему индексу customer_id. Итоговый датафрейм содержfk 19 столбцов и 7043 строк.

При изучении данных выяснилось, что:
    
- В названиях столбцов присутствуют заглавные буквы и имеет место слитное написание слов.
- В столбцах BeginDate и TotalCharges тип данных не соответствует содержащимся в них данным (дата заключения контракта и общая сумма).
- Столбец EndDate содержит информацию о дате прекращения контракта или No в случае если он действующий.
- В столбцах, отражающих подключенные услуги, в результате объединения таблиц образовались пропуски. Эти пропуски возникли в тех строках, где услуга не была подключена.
    
В результате предобработки данных:

- Названия столбцов приведены к стандартному виду.
- Столбец begin_date с датой заключения контракта, имеющий тип object, приведен к типу datetime.
- Столбец total_charges, содержащий численное значение и имеющий тип данных object, приведен к типу float.
При изучении значений столбца total_charges были обнаружен пробел в 11 строках. В этих строках содержатся записи о контрактах, заключенных 1.02.2020 года (в последний день периода). Информация об оплата по этим контрактам не успела попасть в таблицу. Данные в этих строках были заполнены данными из столбца monthly_charges.
- Пропуски в столбцах, образовавшиеся в результате объединения таблиц и возникшие в строках, гду эти услуги не были подключены я заполнил значением 'No'.
- Создан новый столбец exited, содержащий информацию о том, завешен контракт или нет.
- С помощью столбцов begin_date и end_date создан новый столбец, содержащий информацию о длительности контракта в днях.
Столбцы begin_date и end_date удалены.
    
    
В итоговом датафрейме содержится 19 столбцов и 7043 строки. Задача первого этапа выполнена.

- <b>Исследовательский анализ данных.</b>

В результате исследования данных я выяснил, что:
1. Распределение ежемесячных сборов имет максимум в области 20 и растянутый максимум от 45 до 110. Скорее всего, первый максимум можно объяснить популярным недорогим тарифом, включающим базовый пакет услуг, без подключения интернета. Остальные тарифы распределены широко в диапазоне от 45 до 110 и содержат комбинацию различных услуг.

Распределение полных сборов начинается с высокого максимума в области 20 и плавного спуска с увеличением суммы. Чем больше сумма, тем меньше клиентов готовы ее платить.

2. Большинство клиентов заключают контракты Month-to-month в безбумажной форме и оплачивают их электронным переводом.
3. Среди клиентов примерно одинаковое количество мужчин и женщин и около 15% людей старшего возраста.
4. Около четверти клиентов не пользуется интернетом, а среди тех, кто пользуется - предпочитают оптоволокно.
5. Меньшая часть клиентов подключают дополнительные услуги: блокировку небезопасных сайтов, облачное хранилище файлов для резервного копирования данных, антивирус, выделенную линия технической поддержки, стриминговое телевидение, каталог фильмов.
6. Меньше половины клиентов готовы оплачивать телефонную связь с возможностью подключения телефонного аппарата к нескольким линиям одновременно.
7. Около тысячи клиентов отказались от услуг компании.
8. Длительности действующих контрактов рассчитывались как период от заключения контракта до конца периода исследования (01.02.2020г.). С течением времени незавершенных контрактов прибавляется, а их сроки до зафиксированной даты становятся меньше. Поэтому распределение не равномерное, а имеет подъем в сторону меньших значений. Отдельно хочу отметить выброс в области длительности контрактов более 2150 дней. Этот выброс объясняется контрактами, заключеннымии партнерами в начале исследуемого периода и действующими  на момент проведения исследования.

Данные качественные. Можно переходить к их подготовке к машинному обучению.

- <b>Подготовка данных к машинному обучению.</b>

Подготовленные данные я разделил на на тренировочную и тестовую выборки в соотношении 3:1 с применением стратификации выборки по целевому признаку.

В результате исследования корреляции между признаками выявлен признак gender у котороко практически нулевая корреляция с другими признаками. Признак gender удален.

Корреляция между признаками и целевым признаком оказалась очень низкая. Самое большое значение $\phi_K$=0.37 у признака days. У половины признаков коэффициент корреляции равен нулю.

При подготовке данных к машинному обучению:
- Значения категориального признака type, содержащего название типа контракта month-to-month, one year и  two year, перевел в численные значения длительности контракта в месяцах.
- Значения категориальных признаков yes и no заменены на 0 и 1.
- К категориальным признакам, содержащим больше двух значений применена техника прямого кодирования OHE.

В резултате проведения исследования важности признаков с ипользованием модели случайный лес выявилось двенадцать важных признаков: days, total_charges, monthly_charges, type, senior_citizen, onehotencoder__x0_Mailed check, onehotencoder__x0_Credit card (automatic), onehotencoder__x0_Bank transfer (automatic), onehotencoder__x0_Electronic check, onehotencoder__x1_Fiber optic, onehotencoder__x1_DSL, onehotencoder__x1_No. Эти признаки я оставил в выборках, остальные удалил.

Задача этапа выполнена. Данные подготовлены к машинному обучению.

- <b>Обучение моделей.</b>

Для пресказания бинарного категорийного целевого признака мне нужно было решить задачу классификации. Для обучения я выбрал модели RandomForest, LightGBM и CatBoost.

Все модели обучались на тренировочной выборке с использованием кросс-валидации. Гиперпараметры моделей подбирались на фиксированной сетке возможных значений с помощью GridSearchCV. Параметр cv я выбрал равным 3 для ускорения обучения. При обучении использовалась основная метрика ROC-AUC и дополнительные Recall, F1-мера и Precision.

Модель RandomForest с гиперпараметрами n-estimators=300, max_depth=7, min_samples_leaf=3 показала на тренировочной выборке с использованием кросс-валидации значение метрики ROC-AUC = 0.8133.

Модель LightGBM с гиперпараметрами n-estimators=150, learning_rate=0.6, max_depth=5, num_leaves=5 показала на тренировочной выборке с использованием кросс-валидации значение метрики ROC-AUC = 0.8605.

Модель CatBoost с гиперпараметрами iterations=200, learning_rate=0.5, depth=4, l2_leaf_reg=5 показала на тренировочной выборке с использованием кросс-валидации значение метрики ROC-AUC = 0.9000.

Лучшее значение метрики ROC-AUC на тренировочной выборке с использованием кросс-валидации показала модель CatBoost (0.9000). Именно ее я выбираю для тестирования на тестовой выборке.

Результаты тестирования лучшей модели CatBoost на тестовой выборке:
- Анализ важности признаков обученной лучшей модели CatBoost показал, что признаки для обучения были отбраны правильно.
- <b>Значение метрики ROC-AUC на тестовой выборке составило 0.9185. Это значение выше установленного заказчиком порого 0.85. Это значит, что модель выдержала испытание и может быть рекомендована оператору связи для прогнозирования оттока клиентов.</b>
- Значения метрик на тестовой выборке: F1-мера = 0.75, Precision = 0.89, Recall = 0.65.
- На матрице ошибок видно, что из 275 клиентов, планирующих уйти, модель предсказала 178 и из 1486 лояльных клинтов верно определила 1463.

Модель на 65% правильно определила предстоящий уход клиентов. Это достаточно высокий показатель. Использование модели позволит вовремя предложить таким клиентам особые условия и не упустить прибыль.

<b>Все пункты первоначального плана выполнены. Модель обучена на предоставленных заказчиком данных и готова прогнозировать отток клиентов с наилучшей точностью и значением метрики AUC-ROC не ниже 0.85.</b>

